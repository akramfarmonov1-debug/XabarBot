{% extends "base.html" %}

{% block title %}Bilim Bazasi - XabarBot.UZ{% endblock %}

{% block content %}
<div class="container" style="margin-top: 100px;">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card border-0 shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="bi bi-file-earmark-text me-2"></i>Bilim Bazasi
                    </h4>
                </div>
                
                <div class="card-body p-4">
                    {% if current_file %}
                        <!-- Current File Info -->
                        <div class="alert alert-success">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="alert-heading mb-1">
                                        <i class="bi bi-check-circle me-2"></i>Fayl yuklangan
                                    </h6>
                                    <p class="mb-0">{{ current_file.file_name }}</p>
                                    <small class="text-muted">
                                        Yuklandi: {{ current_file.uploaded_at.strftime('%d.%m.%Y %H:%M') }}
                                    </small>
                                </div>
                                <a href="{{ url_for('kb.delete_file') }}" 
                                   class="btn btn-outline-danger btn-sm"
                                   onclick="return confirm('Faylni o\'chirmoqchimisiz?')">
                                    <i class="bi bi-trash"></i> O'chirish
                                </a>
                            </div>
                        </div>
                    {% endif %}
                    
                    <div class="mb-4">
                        <h5>Fayl yuklash</h5>
                        <p class="text-muted">
                            PDF, DOCX, CSV yoki TXT faylni yuklang. AI sizning ma'lumotlaringiz asosida javob beradi.
                        </p>
                    </div>
                    
                    <form method="POST" enctype="multipart/form-data" id="upload-form">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="mb-3">
                            <label for="file" class="form-label">Fayl tanlang</label>
                            <input type="file" 
                                   class="form-control" 
                                   id="file" 
                                   name="file" 
                                   accept=".pdf,.docx,.csv,.txt"
                                   required>
                            <div class="form-text">
                                Qo'llab-quvvatlanadigan formatlar: PDF, DOCX, CSV, TXT (max 10MB)
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="additional_text" class="form-label">Qo'shimcha ma'lumot (ixtiyoriy)</label>
                            <textarea class="form-control" 
                                      id="additional_text" 
                                      name="additional_text" 
                                      rows="4"
                                      placeholder="Fayl haqida qo'shimcha ma'lumot yozing..."></textarea>
                            <div class="form-text">
                                AI sizning faylingiz va qo'shimcha ma'lumotlaringiz asosida javob beradi
                            </div>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg" id="upload-btn">
                                <i class="bi bi-upload me-2"></i>Yuklash
                            </button>
                        </div>
                    </form>
                    
                    <!-- Upload Progress -->
                    <div class="mt-3" id="upload-progress" style="display: none;">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" 
                                 style="width: 0%"
                                 id="progress-bar">
                            </div>
                        </div>
                        <small class="text-muted mt-1 d-block">Fayl yuklanmoqda...</small>
                    </div>
                </div>
                
                <div class="card-footer bg-light">
                    <div class="row g-3">
                        <div class="col-md-3 text-center">
                            <i class="bi bi-file-pdf text-danger" style="font-size: 2rem;"></i>
                            <div class="small mt-1">PDF</div>
                        </div>
                        <div class="col-md-3 text-center">
                            <i class="bi bi-file-word text-primary" style="font-size: 2rem;"></i>
                            <div class="small mt-1">DOCX</div>
                        </div>
                        <div class="col-md-3 text-center">
                            <i class="bi bi-file-spreadsheet text-success" style="font-size: 2rem;"></i>
                            <div class="small mt-1">CSV</div>
                        </div>
                        <div class="col-md-3 text-center">
                            <i class="bi bi-file-text text-secondary" style="font-size: 2rem;"></i>
                            <div class="small mt-1">TXT</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- How it works -->
            <div class="card border-0 shadow mt-4">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-question-circle me-2"></i>Qanday ishlaydi?
                    </h5>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="text-center">
                                <i class="bi bi-upload text-primary mb-2" style="font-size: 2rem;"></i>
                                <h6>1. Fayl yuklash</h6>
                                <p class="small text-muted">
                                    PDF, DOCX, CSV yoki TXT faylni yuklang
                                </p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <i class="bi bi-cpu text-success mb-2" style="font-size: 2rem;"></i>
                                <h6>2. Tahlil qilish</h6>
                                <p class="small text-muted">
                                    AI sizning faylingizni tahlil qiladi
                                </p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <i class="bi bi-chat-dots text-info mb-2" style="font-size: 2rem;"></i>
                                <h6>3. Chat qilish</h6>
                                <p class="small text-muted">
                                    Ma'lumotlaringiz asosida savollar bering
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const uploadForm = document.getElementById('upload-form');
const uploadBtn = document.getElementById('upload-btn');
const uploadProgress = document.getElementById('upload-progress');
const progressBar = document.getElementById('progress-bar');

uploadForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const file = document.getElementById('file').files[0];
    
    if (!file) {
        alert('Iltimos, fayl tanlang');
        return;
    }
    
    // Check file size (10MB limit)
    if (file.size > 10 * 1024 * 1024) {
        alert('Fayl hajmi 10MB dan oshmasin');
        return;
    }
    
    // Show progress
    uploadBtn.disabled = true;
    uploadBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Yuklanmoqda...';
    uploadProgress.style.display = 'block';
    
    // Simulate progress
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 90) progress = 90;
        progressBar.style.width = progress + '%';
    }, 200);
    
    // Submit form
    fetch(window.location.href, {
        method: 'POST',
        body: formData
    })
    .then(response => response.text())
    .then(html => {
        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        
        setTimeout(() => {
            // Reload page to show results
            window.location.reload();
        }, 500);
    })
    .catch(error => {
        clearInterval(progressInterval);
        uploadProgress.style.display = 'none';
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = '<i class="bi bi-upload me-2"></i>Yuklash';
        alert('Xatolik yuz berdi. Iltimos, qayta urinib ko\'ring.');
    });
});

// File validation
document.getElementById('file').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const allowedTypes = ['.pdf', '.docx', '.csv', '.txt'];
        const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
        
        if (!allowedTypes.includes(fileExtension)) {
            alert('Faqat PDF, DOCX, CSV, TXT fayllar qabul qilinadi');
            this.value = '';
            return;
        }
        
        if (file.size > 10 * 1024 * 1024) {
            alert('Fayl hajmi 10MB dan oshmasin');
            this.value = '';
            return;
        }
    }
});
</script>
{% endblock %}