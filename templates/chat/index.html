{% extends "base.html" %}

{% block title %}AI Chat - XabarBot.UZ{% endblock %}

{% block content %}
<div class="container-fluid" style="margin-top: 80px; height: calc(100vh - 120px);">
    <div class="row h-100">
        <!-- Chat Container -->
        <div class="col-12">
            <div class="card h-100 border-0 shadow">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-robot me-2"></i>AI Yordamchisi
                        </h5>
                        <button class="btn btn-sm btn-outline-light" onclick="clearChat()">
                            <i class="bi bi-trash"></i> Tozalash
                        </button>
                    </div>
                </div>
                
                <div class="card-body d-flex flex-column p-0">
                    <!-- Chat Messages -->
                    <div class="flex-grow-1 p-3" id="chat-messages" style="overflow-y: auto; max-height: 70vh;">
                        <div class="message-container">
                            <div class="message ai-message">
                                <div class="d-flex mb-3">
                                    <div class="avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                        <i class="bi bi-robot"></i>
                                    </div>
                                    <div class="message-content bg-light p-3 rounded">
                                        <p class="mb-0">Salom! Men sizning AI yordamchingizman. Menga savollaringizni bering, men sizga yordam berishga tayyorman.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chat Input -->
                    <div class="border-top p-3">
                        <form id="chat-form" class="d-flex gap-2">
                            <input type="text" 
                                   id="message-input" 
                                   class="form-control" 
                                   placeholder="Savolingizni yozing..."
                                   autocomplete="off"
                                   required>
                            <button type="submit" class="btn btn-primary" id="send-button">
                                <i class="bi bi-send"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.message-container {
    margin-bottom: 1rem;
}

.user-message .d-flex {
    flex-direction: row-reverse;
}

.user-message .message-content {
    background-color: #007bff;
    color: white;
}

.ai-message .message-content {
    background-color: #f8f9fa;
    color: #333;
}

.avatar {
    flex-shrink: 0;
}

.typing-indicator {
    display: none;
}

.typing-indicator.show {
    display: block;
}

.typing-dots {
    display: inline-block;
    position: relative;
}

.typing-dots::after {
    content: '...';
    animation: typing 1.4s infinite;
}

@keyframes typing {
    0%, 60% { opacity: 0; }
    30% { opacity: 1; }
}
</style>

<script>
const chatForm = document.getElementById('chat-form');
const messageInput = document.getElementById('message-input');
const chatMessages = document.getElementById('chat-messages');
const sendButton = document.getElementById('send-button');

chatForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const message = messageInput.value.trim();
    if (!message) return;
    
    // Add user message
    addMessage(message, 'user');
    messageInput.value = '';
    
    // Show typing indicator
    showTypingIndicator();
    
    // Disable input
    messageInput.disabled = true;
    sendButton.disabled = true;
    
    try {
        const response = await fetch('{{ url_for("chat.send") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            },
            body: JSON.stringify({ message: message })
        });
        
        const data = await response.json();
        
        // Hide typing indicator
        hideTypingIndicator();
        
        if (data.success) {
            addMessage(data.response, 'ai');
        } else {
            addMessage('Kechirasiz, xatolik yuz berdi. Iltimos, qayta urinib ko\'ring.', 'ai');
        }
    } catch (error) {
        hideTypingIndicator();
        addMessage('Aloqa xatosi. Iltimos, internetingizni tekshirib qayta urinib ko\'ring.', 'ai');
    }
    
    // Re-enable input
    messageInput.disabled = false;
    sendButton.disabled = false;
    messageInput.focus();
});

function addMessage(content, sender) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message`;
    
    const avatar = sender === 'ai' ? 
        '<div class="avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;"><i class="bi bi-robot"></i></div>' :
        '<div class="avatar bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center ms-3" style="width: 40px; height: 40px;"><i class="bi bi-person"></i></div>';
    
    messageDiv.innerHTML = `
        <div class="d-flex mb-3">
            ${avatar}
            <div class="message-content p-3 rounded">
                <p class="mb-0">${content}</p>
            </div>
        </div>
    `;
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function showTypingIndicator() {
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message ai-message typing-indicator show';
    typingDiv.id = 'typing-indicator';
    
    typingDiv.innerHTML = `
        <div class="d-flex mb-3">
            <div class="avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                <i class="bi bi-robot"></i>
            </div>
            <div class="message-content bg-light p-3 rounded">
                <p class="mb-0 typing-dots">Yozmoqda</p>
            </div>
        </div>
    `;
    
    chatMessages.appendChild(typingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function hideTypingIndicator() {
    const typingIndicator = document.getElementById('typing-indicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

function clearChat() {
    if (confirm('Barcha xabarlarni o\'chirmoqchimisiz?')) {
        chatMessages.innerHTML = `
            <div class="message-container">
                <div class="message ai-message">
                    <div class="d-flex mb-3">
                        <div class="avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                            <i class="bi bi-robot"></i>
                        </div>
                        <div class="message-content bg-light p-3 rounded">
                            <p class="mb-0">Salom! Men sizning AI yordamchingizman. Menga savollaringizni bering, men sizga yordam berishga tayyorman.</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
}

// Focus on input when page loads
document.addEventListener('DOMContentLoaded', () => {
    messageInput.focus();
});
</script>
{% endblock %}